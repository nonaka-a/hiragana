<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã²ã‚‰ãŒãªã‚Œã‚“ã—ã‚…ã†</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* ãƒãƒƒãƒ—ãªã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
            --bg-color: #FFF9E6;      /* è–„ã„é»„è‰² */
            --bg-dot: #FFE4B5;        /* ãƒ‰ãƒƒãƒˆè‰² */
            --main-pink: #FF8BA7;
            --main-blue: #8BE3FF;
            --main-green: #98EE99;
            --main-yellow: #FFEB3B;
            --accent-orange: #FFB74D;
            --text-color: #5D4037;    /* èŒ¶è‰²ã£ã½ã„é»’ */
            
            --font-family: 'Noto Sans JP', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--bg-dot) 20%, transparent 20%), radial-gradient(var(--bg-dot) 20%, transparent 20%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: none;
            padding: 10px;
            box-sizing: border-box;
        }

        h1 {
            color: #FF6B6B;
            margin: 15px 0;
            font-size: 1.6rem;
            text-align: center;
            text-shadow: 2px 2px 0 #FFF;
            background: rgba(255,255,255,0.8);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #FF8BA7;
        }

        p {
            margin-top: 0;
            background: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.4s ease-out;
        }
        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- 50éŸ³è¡¨ --- */
        .gojuon-container {
            display: flex;
            flex-direction: row-reverse;
            gap: 6px;
            overflow-x: auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            border: 4px solid var(--main-blue);
            box-shadow: 0 6px 0 #6BC3DF;
            max-width: 100%;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .char-btn {
            width: 44px;
            height: 44px;
            background: #fff;
            border: 2px solid var(--main-pink);
            border-radius: 12px;
            font-size: 1.3rem;
            font-family: var(--font-family);
            font-weight: 700;
            color: var(--text-color);
            cursor: pointer;
            box-shadow: 0 3px 0 #FF6B8B;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.1s;
        }
        .char-btn:active {
            transform: translateY(3px);
            box-shadow: none;
            background-color: #FFF0F5;
        }
        .char-btn.empty {
            border: none;
            background: transparent;
            box-shadow: none;
            cursor: default;
        }

        /* --- ç·´ç¿’ç”»é¢ --- */
        .canvas-area {
            position: relative;
            background: white;
            padding: 8px;
            border-radius: 20px;
            border: 5px solid var(--accent-orange);
            box-shadow: 0 6px 0 #E65100;
            margin-top: 10px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        canvas {
            display: block;
            border-radius: 12px;
            cursor: crosshair;
            background-color: #FFF;
        }

        /* æ›¸ãé †GIFã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #stroke-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        #stroke-overlay img {
            width: 250px;
            height: 250px;
            border: 4px solid var(--main-blue);
            border-radius: 15px;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            object-fit: contain;
        }
        
        /* ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºç”¨ */
        .overlay-msg {
            position: absolute;
            font-size: 1rem;
            color: var(--text-color);
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }
        .overlay-msg.error {
            color: #FF6B6B;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            font-family: var(--font-family);
            border: none;
            padding: 12px 20px;
            font-size: 1.1rem;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
            cursor: pointer;
            min-width: 110px;
            transition: transform 0.1s;
        }
        button:active { transform: translateY(4px) !important; box-shadow: none !important; }

        .btn-check { 
            background-color: #66BB6A; 
            box-shadow: 0 4px 0 #388E3C;
        }
        .btn-reset { 
            background-color: #FFA726; 
            box-shadow: 0 4px 0 #F57C00;
        }
        .btn-anim  { 
            background-color: #42A5F5; 
            box-shadow: 0 4px 0 #1976D2;
        }
        .btn-back  { 
            background-color: #AB47BC; 
            box-shadow: 0 4px 0 #7B1FA2;
            margin-top: 25px; 
            width: 160px; 
        }

        #result-msg {
            height: 45px;
            margin-top: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 0 20px;
            min-width: 200px;
        }

    </style>
</head>
<body>

    <audio id="se-success" src="sounds/success.mp3"></audio>

    <!-- ä¸€è¦§ç”»é¢ -->
    <div id="screen-list" class="screen active">
        <h1>ğŸˆ ã²ã‚‰ãŒãª ã‚Œã‚“ã—ã‚…ã† ğŸˆ</h1>
        <p>ã‚Œã‚“ã—ã‚…ã†ã™ã‚‹ ã‚‚ã˜ã‚’ ãˆã‚‰ã‚“ã§ã­ï¼</p>
        <div class="gojuon-container" id="gojuon-container">
            <!-- JSã§ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ç·´ç¿’ç”»é¢ -->
    <div id="screen-practice" class="screen">
        <h1 id="practice-title">ã‚Œã‚“ã—ã‚…ã†</h1>
        
        <div class="canvas-area">
            <canvas id="drawingBoard" width="300" height="300"></canvas>
            
            <!-- æ›¸ãé †è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="stroke-overlay" onclick="hideStrokeDemo()">
                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ -->
                <div id="overlay-text" class="overlay-msg"></div>
                
                <img id="stroke-gif" src="" alt="" onload="onGifLoad()" onerror="onGifError()">
                
                <p style="position: absolute; bottom: 10px; font-size:1rem; color:var(--text-color); font-weight:bold; margin:0;">
                    ã‚¿ãƒƒãƒ—ã—ã¦ ã‚‚ã©ã‚‹
                </p>
            </div>
        </div>

        <div class="controls">
            <button class="btn-reset" onclick="resetCanvas()">ğŸ¨ ã‹ããªãŠã™</button>
            <button class="btn-anim" onclick="showStrokeDemo()">ğŸ‘€ ã‹ãã‹ãŸ</button>
            <button class="btn-check" onclick="checkScore()">ğŸ’¯ ã¯ã‚“ã¦ã„</button>
        </div>

        <div id="result-msg"></div>

        <button class="btn-back" onclick="goBack()">â†© ã„ã¡ã‚‰ã‚“ã¸</button>
    </div>

    <script>
        // --- è¨­å®š ---
        const columns = [
            ['ã‚','ã„','ã†','ãˆ','ãŠ'],
            ['ã‹','ã','ã','ã‘','ã“'],
            ['ã•','ã—','ã™','ã›','ã'],
            ['ãŸ','ã¡','ã¤','ã¦','ã¨'],
            ['ãª','ã«','ã¬','ã­','ã®'],
            ['ã¯','ã²','ãµ','ã¸','ã»'],
            ['ã¾','ã¿','ã‚€','ã‚','ã‚‚'],
            ['ã‚„','','ã‚†','','ã‚ˆ'],
            ['ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚'],
            ['ã‚','','ã‚’','','ã‚“']
        ];

        const romajiMap = {
            'ã‚':'a', 'ã„':'i', 'ã†':'u', 'ãˆ':'e', 'ãŠ':'o',
            'ã‹':'ka', 'ã':'ki', 'ã':'ku', 'ã‘':'ke', 'ã“':'ko',
            'ã•':'sa', 'ã—':'shi', 'ã™':'su', 'ã›':'se', 'ã':'so',
            'ãŸ':'ta', 'ã¡':'chi', 'ã¤':'tsu', 'ã¦':'te', 'ã¨':'to',
            'ãª':'na', 'ã«':'ni', 'ã¬':'nu', 'ã­':'ne', 'ã®':'no',
            'ã¯':'ha', 'ã²':'hi', 'ãµ':'fu', 'ã¸':'he', 'ã»':'ho',
            'ã¾':'ma', 'ã¿':'mi', 'ã‚€':'mu', 'ã‚':'me', 'ã‚‚':'mo',
            'ã‚„':'ya', 'ã‚†':'yu', 'ã‚ˆ':'yo',
            'ã‚‰':'ra', 'ã‚Š':'ri', 'ã‚‹':'ru', 'ã‚Œ':'re', 'ã‚':'ro',
            'ã‚':'wa', 'ã‚’':'wo', 'ã‚“':'n'
        };

        // --- å¤‰æ•° ---
        let currentChar = '';
        const canvas = document.getElementById('drawingBoard');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        const guideCanvas = document.createElement('canvas');
        guideCanvas.width = canvas.width;
        guideCanvas.height = canvas.height;
        const guideCtx = guideCanvas.getContext('2d', { willReadFrequently: true });

        const GUIDE_COLOR = "#DDDDDD"; 
        const BRUSH_COLOR = "#333333";
        const BRUSH_SIZE = 24; 

        // --- åˆæœŸåŒ– ---
        window.onload = function() {
            createList();
        };

        function createList() {
            const container = document.getElementById('gojuon-container');
            columns.forEach((colChars, index) => {
                const colDiv = document.createElement('div');
                colDiv.className = 'column';
                colChars.forEach(char => {
                    const btn = document.createElement('div');
                    btn.className = 'char-btn';
                    
                    const colors = ['#FF8BA7', '#FFB74D', '#FFF176', '#AED581', '#8BE3FF', '#BA68C8', '#FF8A65', '#90A4AE', '#DCE775', '#4DB6AC'];
                    if (char !== '') {
                        btn.style.borderColor = colors[index % colors.length];
                        btn.style.boxShadow = `0 3px 0 ${colors[index % colors.length]}`;
                    }

                    if (char === '') {
                        btn.classList.add('empty');
                    } else {
                        btn.textContent = char;
                        btn.onclick = () => startPractice(char);
                    }
                    colDiv.appendChild(btn);
                });
                container.appendChild(colDiv);
            });
        }

        // --- ç”»é¢é·ç§» ---
        function startPractice(char) {
            currentChar = char;
            document.getElementById('practice-title').textContent = `ã€Œ${char}ã€ã® ã‚Œã‚“ã—ã‚…ã†`;
            document.getElementById('screen-list').classList.remove('active');
            document.getElementById('screen-practice').classList.add('active');
            document.getElementById('result-msg').innerHTML = ""; 
            resetCanvas();
        }

        function goBack() {
            document.getElementById('screen-practice').classList.remove('active');
            document.getElementById('screen-list').classList.add('active');
            hideStrokeDemo();
        }

        // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        function resetCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.font = "bold 200px 'Noto Sans JP', sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = GUIDE_COLOR;
            ctx.fillText(currentChar, canvas.width / 2, canvas.height / 2 + 18);

            guideCtx.clearRect(0, 0, canvas.width, canvas.height);
            guideCtx.fillStyle = "white";
            guideCtx.fillRect(0, 0, canvas.width, canvas.height);
            guideCtx.font = "bold 200px 'Noto Sans JP', sans-serif";
            guideCtx.textAlign = "center";
            guideCtx.textBaseline = "middle";
            guideCtx.fillStyle = GUIDE_COLOR;
            guideCtx.fillText(currentChar, canvas.width / 2, canvas.height / 2 + 18);
            
            document.getElementById('result-msg').innerHTML = "";
        }

        // --- æ›¸ãé †ï¼ˆGIFã‚¢ãƒ‹ãƒ¡ï¼‰è¡¨ç¤º ---
        function showStrokeDemo() {
            const overlay = document.getElementById('stroke-overlay');
            const img = document.getElementById('stroke-gif');
            const msg = document.getElementById('overlay-text');
            
            const romaji = romajiMap[currentChar];

            if (romaji) {
                // UIãƒªã‚»ãƒƒãƒˆ
                msg.style.display = 'block';
                msg.textContent = "ã‚ˆã¿ã“ã¿ä¸­...";
                msg.className = "overlay-msg"; // ã‚¯ãƒ©ã‚¹ãƒªã‚»ãƒƒãƒˆ
                
                img.style.display = 'none'; // èª­ã¿è¾¼ã¿å®Œäº†ã¾ã§éš ã™
                img.src = ""; // ä¸€æ—¦ã‚¯ãƒªã‚¢
                
                // ç”»åƒURLã‚»ãƒƒãƒˆ (GitHub Raw)
                img.src = `https://raw.githubusercontent.com/jshier/hiragana-gifs/master/gifs/${romaji}.gif`;
                
                overlay.style.display = 'flex';
            } else {
                // ç”»åƒå®šç¾©ãŒãªã„å ´åˆ
                overlay.style.display = 'flex';
                msg.textContent = "ã“ã®ã‚‚ã˜ã® ã‹ãã‹ãŸã¯ ã‚ã‚Šã¾ã›ã‚“";
                msg.className = "overlay-msg error";
                img.style.display = 'none';
            }
        }

        function onGifLoad() {
            // èª­ã¿è¾¼ã¿æˆåŠŸ
            document.getElementById('overlay-text').style.display = 'none';
            document.getElementById('stroke-gif').style.display = 'block';
        }

        function onGifError() {
            // èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆã“ã“ã§ã®alertã‚’å‰Šé™¤ã—ã€ç”»é¢å†…è¡¨ç¤ºã«å¤‰æ›´ï¼‰
            const msg = document.getElementById('overlay-text');
            const img = document.getElementById('stroke-gif');
            
            img.style.display = 'none';
            msg.style.display = 'block';
            msg.textContent = "ã”ã‚ã‚“ã­ã€ãŒãã†ãŒ ã¿ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
            msg.className = "overlay-msg error";
        }

        function hideStrokeDemo() {
            document.getElementById('stroke-overlay').style.display = 'none';
            document.getElementById('stroke-gif').src = ""; 
        }

        // --- ãŠçµµã‹ãæ©Ÿèƒ½ ---
        let isDrawing = false;
        let lastX = 0, lastY = 0;

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startD(e) {
            e.preventDefault();
            isDrawing = true;
            const p = getPos(e);
            lastX = p.x; lastY = p.y;
            moveD(e);
        }

        function moveD(e) {
            if(!isDrawing) return;
            e.preventDefault();
            const p = getPos(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(p.x, p.y);
            ctx.strokeStyle = BRUSH_COLOR;
            ctx.lineWidth = BRUSH_SIZE;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            ctx.stroke();
            lastX = p.x; lastY = p.y;
        }

        function endD() { isDrawing = false; }

        canvas.addEventListener('mousedown', startD);
        canvas.addEventListener('mousemove', moveD);
        canvas.addEventListener('mouseup', endD);
        canvas.addEventListener('mouseout', endD);
        canvas.addEventListener('touchstart', startD, {passive:false});
        canvas.addEventListener('touchmove', moveD, {passive:false});
        canvas.addEventListener('touchend', endD);

        // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
        function checkScore() {
            const w = canvas.width, h = canvas.height;
            const uData = ctx.getImageData(0,0,w,h).data;
            const gData = guideCtx.getImageData(0,0,w,h).data;

            let match = 0, guideArea = 0, out = 0;

            for(let i=0; i<uData.length; i+=4) {
                const isGuide = gData[i] < 240; 
                const isUser  = uData[i] < 150;

                if(isGuide) {
                    guideArea++;
                    if(isUser) match++;
                } else {
                    if(isUser) out++;
                }
            }

            if(guideArea === 0) return;

            let score = (match / guideArea) * 100;
            let penalty = (out / guideArea) * 40; 
            
            let finalScore = Math.round(score - penalty);
            if(finalScore < 0) finalScore = 0;
            if(finalScore > 100) finalScore = 100;

            const resDiv = document.getElementById('result-msg');
            
            if(finalScore >= 60) {
                resDiv.innerHTML = `<span style="color:#E91E63">ğŸ’® ${finalScore}ã¦ã‚“ï¼ ã˜ã‚‡ã†ãšï¼</span>`;
                playSound();
            } else {
                resDiv.innerHTML = `<span style="color:#1976D2">ğŸ’§ ${finalScore}ã¦ã‚“ã€‚ ã‚‚ã†ã™ã“ã—ï¼</span>`;
            }
        }

        function playSound() {
            const audio = document.getElementById('se-success');
            audio.currentTime = 0;
            audio.play().catch(e => console.log("SEå†ç”Ÿã‚¨ãƒ©ãƒ¼: " + e));
        }

    </script>
</body>
</html>